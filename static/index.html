<!doctype html>
<html lang="zh-Hant" class="light">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>網球比賽分析助手</title>

  <!-- 字體 -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap">
  <link rel="stylesheet" href="static/index.css?v=19" />

  <!-- <script>
    // 動態插入 CSS（自動防快取）
    const css = document.createElement("link");
    css.rel = "stylesheet";
    css.href = "static/index.css?v=" + Date.now();
    document.head.appendChild(css);
  </script> -->
</head>

<body class="light">
  <!-- Header：兩個獨立玻璃塊 -->
  <header>
    <div class="glass-base header-chip">
      網球比賽分析助手
    </div>
    <theme-toggle></theme-toggle>
  </header>

  <!-- 主內容 -->
  <div class="main">
    <!-- LLM 卡 -->
    <div class="glass-base llm-card">
      <div id="chat"></div>
      <div class="composer">
        <textarea id="query" placeholder="輸入你的問題..."></textarea>
        <button class="send-btn" id="sendBtn" disabled>送出</button>
      </div>
    </div>

    <!-- 右側：控制卡 + 影片卡 -->
    <div class="right-col">
      <!-- 控制卡 -->
      <div class="glass-base control-card">
        <div class="control-row">
          <input id="file" type="file" accept="video/*" style="display:none;">
          <button class="btn btn-green" id="analyzeBtn" disabled>YOLO 分析</button>
          <button class="btn" id="resetBtn">重置</button>
          <div class="progress-bar-wrap" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
          </div>
        </div>

        <div id="status">請先上傳影片</div>

        <div id="videoInfo"></div>
      </div>
      <!-- 影片卡 -->
      <div class="glass-base video-card">
        <div class="video-wrapper" id="dropZone">
          <div id="videoPlaceholder">
            <img src="/static/update.svg" id="uploadIcon" alt="上傳圖示">
            <div>點擊新增或拖曳影片檔案到此區塊</div>
            <button class="vp-upload-btn" id="videoUploadBtn"></button>
          </div>
          <video id="videoPlayer" controls></video>
          <canvas id="overlay"></canvas>
        </div>
      </div>
    </div>
  </div>
  <script type="module" src="static/theme-toggle.js"></script>
  <script type="module">
    // 超簡單防快取：每次重新整理都拿到一組新版本號 
    // true = 防快取 / false = 不防快取
    const DevelopmentMode = true;
    // const DevelopmentMode = false;

    const state = {
      sessionId: null,
      videoMeta: null,
      localVideoUrl: null,
      ballTracks: [],
      poses: [],
      tracksByFrame: {},
      posesByFrame: {},
      detectionReady: false,
      frameOffset: 0,
      rafId: null,
      pollInterval: null,
      analysisCompleted: false,
      isBusy: false,
      autoScroll: true,
    };

    const $ = (id) => document.getElementById(id);

    const dom = {
      body: document.body,
      themeToggle: $("themeToggle"),

      chatEl: $("chat"),
      fileEl: $("file"),
      videoUploadBtn: $("videoUploadBtn"),
      videoInfoEl: $("videoInfo"),
      queryEl: $("query"),
      sendBtn: $("sendBtn"),
      statusEl: $("status"),
      analyzeBtn: $("analyzeBtn"),
      videoEl: $("videoPlayer"),
      canvasEl: $("overlay"),
      wrapperEl: $("dropZone"),
      resetBtn: $("resetBtn"),
      progressContainer: $("progressContainer"),
      progressBar: $("progressBar"),
      placeholderEl: $("videoPlaceholder"),
    };

    /* ===== UI 工具 ===== */

    function appendMessage(role, text) {
      const row = document.createElement("div");
      row.className = `msg-row ${role}`;
      const bubble = document.createElement("div");
      bubble.className = `bubble ${role}`;
      bubble.textContent = text;
      row.appendChild(bubble);
      dom.chatEl.appendChild(row);
      if (state.autoScroll) dom.chatEl.scrollTop = dom.chatEl.scrollHeight;
      return bubble;
    }

    function showError(msg) {
      console.error(msg);
      dom.statusEl.textContent = msg;
      appendMessage("assistant", "⚠️ " + msg);
    }

    function showInfo(msg) {
      dom.statusEl.textContent = msg;
      appendMessage("assistant", msg);
    }

    function isNearBottom(el, threshold = 40) {
      return el.scrollHeight - (el.scrollTop + el.clientHeight) <= threshold;
    }

    dom.chatEl.addEventListener("scroll", () => {
      state.autoScroll = isNearBottom(dom.chatEl);
    });


    function updateButtons() {
      const hasSession = !!state.sessionId;

      dom.sendBtn.disabled = !hasSession || state.isBusy;

      if (!state.analysisCompleted) {
        dom.videoUploadBtn.disabled = state.isBusy;
        dom.analyzeBtn.disabled = !hasSession || state.isBusy;
      } else {
        dom.videoUploadBtn.disabled = true;
        dom.analyzeBtn.disabled = true;
      }
    }

    function updateStatusText() {
      if (!state.sessionId) {
        dom.statusEl.textContent = "請先上傳影片";
        return;
      }
      if (state.isBusy) {
        dom.statusEl.textContent = "處理中...";
        return;
      }
    }

    function setBusy(isBusy) {
      state.isBusy = isBusy;
      updateButtons();
      updateStatusText();
    }

    dom.resetBtn.onclick = () => window.location.reload();

    updateButtons();

    /* ===== 把 ui module 封裝成物件，要傳給 video/chat ===== */
    const UI = { state, dom, utils: { appendMessage, showError, showInfo, setBusy, updateButtons } };


    const importWithVersion = (path) => import(`./${path}${DevelopmentMode ? `?v=${Date.now()}` : ""}`);
    (async () => {
      // 再載入 video / chat，並把 ui 的東西丟進去
      const video = await importWithVersion('static/video.js');
      const chat = await importWithVersion('static/chat.js');

      video.initVideo(UI);
      chat.initChat(UI);
    })();
  </script>
</body>

</html>